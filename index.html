<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh T·∫°o Script Lua Th√¥ng Minh c√≥ B·ªô Nh·ªõ (Delta)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font cho giao di·ªán */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@400&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* N·ªÅn xanh ƒë·∫≠m */
            color: #e2e8f0;
            min-height: 100vh;
        }

        .code-area, .chat-area {
            background-color: #1e293b; /* M√†u t·ªëi h∆°n cho khu v·ª±c code v√† chat */
            border: 1px solid #475569;
            font-family: 'Roboto Mono', monospace; /* Font ƒë∆°n c√°ch cho code */
            font-size: 0.9rem;
            color: #e2e8f0;
            resize: none;
            transition: all 0.2s;
        }
        
        .chat-area {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            overflow-y: auto;
        }

        .code-area:focus, .chat-area:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px #6366f1;
        }

        /* Styling cho n√∫t loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <div class="w-full max-w-4xl space-y-6">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-6 border-b-2 border-indigo-500 pb-2 text-center">
            Tr√¨nh T·∫°o Script Lua Th√¥ng Minh (C√≥ B·ªô Nh·ªõ)
        </h1>
        
        <!-- C·∫£nh b√°o/Th√¥ng b√°o -->
        <div id="status-message" class="bg-indigo-900/50 text-indigo-200 p-3 rounded-lg border-l-4 border-indigo-400 font-medium transition duration-300">
            H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông ·ªü ch·∫ø ƒë·ªô h·ªôi tho·∫°i. Y√™u c·∫ßu c·ªßa b·∫°n ƒë∆∞·ª£c ghi nh·ªõ ƒë·ªÉ c·∫≠p nh·∫≠t script!
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- C·ªôt 1: L·ªãch s·ª≠ H·ªôi tho·∫°i v√† Input -->
            <div>
                <label class="text-lg font-semibold mb-2 block text-indigo-400">
                    1. L·ªãch s·ª≠ H·ªôi tho·∫°i (Memory):
                </label>
                <!-- Khu v·ª±c hi·ªÉn th·ªã l·ªãch s·ª≠ -->
                <div id="chat-history-display" class="chat-area w-full p-3 h-64 rounded-lg mb-4">
                    -- B·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i m·ªõi --
                </div>

                <label for="request-input" class="text-lg font-semibold mb-2 block text-indigo-400">
                    2. Y√™u c·∫ßu C·∫¨P NH·∫¨T ho·∫∑c S·ª≠a l·ªói:
                </label>
                <textarea id="request-input" class="code-area w-full p-3 h-24 rounded-lg" 
                    placeholder="V√≠ d·ª•: 'D·ª±a tr√™n script ƒë√£ t·∫°o, th√™m t√πy ch·ªçn ƒë·ªÉ t·∫Øt/m·ªü ch·ª©c nƒÉng b·∫±ng c√°ch nh·∫•n ph√≠m M.'"></textarea>

                <!-- N√∫t H√†nh ƒë·ªông -->
                <div class="mt-4">
                    <button onclick="generateScript()" id="generate-button" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-xl shadow-indigo-500/50 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="button-text">G·ª≠i Y√™u C·∫ßu (T·∫°o/C·∫≠p Nh·∫≠t Script)</span>
                        <div id="loading-spinner" class="spinner hidden"></div>
                    </button>
                    <button onclick="clearHistory()" 
                            class="w-full mt-2 bg-red-700 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                        X√≥a B·ªô Nh·ªõ H·ªôi Tho·∫°i (B·∫Øt ƒë·∫ßu Script m·ªõi)
                    </button>
                </div>
            </div>

            <!-- C·ªôt 2: Script Output -->
            <div>
                <label for="script-output" class="text-lg font-semibold mb-2 block text-green-400">
                    3. Script Lua ƒê√£ T·∫°o/C·∫≠p Nh·∫≠t:
                </label>
                <textarea id="script-output" class="code-area w-full p-3 h-[300px] rounded-lg" readonly 
                    placeholder="Script Lua ho√†n ch·ªânh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y. Sau m·ªói y√™u c·∫ßu c·∫≠p nh·∫≠t, script n√†y s·∫Ω thay ƒë·ªïi."></textarea>
                
                <button onclick="copyToClipboard()" id="copy-button"
                        class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    Sao Ch√©p Script
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫•u h√¨nh v√† H·∫±ng s·ªë API ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // S·∫Ω ƒë∆∞·ª£c Canvas cung c·∫•p
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        // H∆∞·ªõng d·∫´n h·ªá th·ªëng M·ªöI, t·∫≠p trung v√†o t√≠nh t∆∞∆°ng th√≠ch v·ªõi Mobile Executor V√Ä b·ªô nh·ªõ
        const SYSTEM_INSTRUCTION = "You are an expert Roblox Lua developer specializing in creating high-performance, client-side (LocalScript) code specifically designed for mobile executors like Delta. You are maintaining a conversation memory and must output the FINAL, COMPLETE, and UPDATED Lua script based on the current request and all previous context. Your generated code MUST: 1) Be raw, executable Lua code with no explanations or markdown headers (e.g., no ```lua). 2) Focus on client-side functions and properties. 3) Be optimized to prevent excessive resource usage. Output ONLY the complete, current Lua script.";

        // --- BI·∫æN TO√ÄN C·ª§C CHO B·ªò NH·ªö H·ªòI THO·∫†I ---
        let chatHistory = []; 

        // --- Tham chi·∫øu DOM ---
        const requestInput = document.getElementById('request-input');
        const scriptOutput = document.getElementById('script-output');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const statusMessage = document.getElementById('status-message');
        const chatHistoryDisplay = document.getElementById('chat-history-display');

        // --- C√ÅC H√ÄM TI·ªÜN √çCH ---

        /**
         * C·∫≠p nh·∫≠t hi·ªÉn th·ªã l·ªãch s·ª≠ chat tr√™n UI
         */
        function updateChatDisplay(role, text) {
            const prefix = role === 'user' ? 'üë§ Y√™u C·∫ßu: ' : 'ü§ñ AI Script: ';
            const color = role === 'user' ? 'text-blue-300' : 'text-green-300';
            const content = document.createElement('div');
            content.className = `mb-2 p-1 rounded ${color} whitespace-pre-wrap break-words`;
            content.textContent = prefix + text.substring(0, 100) + (text.length > 100 ? '...' : '');

            chatHistoryDisplay.appendChild(content);
            // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
        }

        /**
         * Thi·∫øt l·∫≠p tr·∫°ng th√°i loading c·ªßa UI
         */
        function setLoadingState(isLoading) {
            generateButton.disabled = isLoading;
            copyButton.disabled = isLoading || scriptOutput.value.length === 0;
            requestInput.disabled = isLoading;
            
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                buttonText.textContent = 'ƒêang X·ª≠ L√Ω...';
                statusMessage.className = 'bg-yellow-900/50 text-yellow-200 p-3 rounded-lg border-l-4 border-yellow-400 font-medium transition duration-300';
                statusMessage.textContent = 'AI ƒëang t·∫°o ho·∫∑c c·∫≠p nh·∫≠t script d·ª±a tr√™n l·ªãch s·ª≠ h·ªôi tho·∫°i.';
            } else {
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'G·ª≠i Y√™u C·∫ßu (T·∫°o/C·∫≠p Nh·∫≠t Script)';
            }
        }

        /**
         * C·ªë g·∫Øng sao ch√©p n·ªôi dung script v√†o clipboard
         */
        function copyToClipboard() {
            if (!scriptOutput.value) {
                statusMessage.className = 'bg-red-900/50 text-red-200 p-3 rounded-lg border-l-4 border-red-400 font-medium transition duration-300';
                statusMessage.textContent = 'Kh√¥ng c√≥ script ƒë·ªÉ sao ch√©p!';
                return;
            }
            
            scriptOutput.select();
            scriptOutput.setSelectionRange(0, 99999); 
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ sao ch√©p:', err);
            }
            
            if (success) {
                statusMessage.className = 'bg-green-900/50 text-green-200 p-3 rounded-lg border-l-4 border-green-400 font-medium transition duration-300';
                statusMessage.textContent = 'ƒê√£ sao ch√©p script v√†o clipboard th√†nh c√¥ng!';
            } else {
                 statusMessage.className = 'bg-red-900/50 text-red-200 p-3 rounded-lg border-l-4 border-red-400 font-medium transition duration-300';
                statusMessage.textContent = 'L·ªói sao ch√©p: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£. Vui l√≤ng sao ch√©p th·ªß c√¥ng.';
            }

            window.getSelection().removeAllRanges();
            scriptOutput.blur();
        }
        
        /**
         * X√≥a b·ªô nh·ªõ h·ªôi tho·∫°i v√† UI
         */
        function clearHistory() {
            chatHistory = [];
            chatHistoryDisplay.innerHTML = '-- B·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i m·ªõi --';
            scriptOutput.value = '';
            setLoadingState(false);
            statusMessage.className = 'bg-indigo-900/50 text-indigo-200 p-3 rounded-lg border-l-4 border-indigo-400 font-medium transition duration-300';
            statusMessage.textContent = 'ƒê√£ x√≥a b·ªô nh·ªõ. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu t·∫°o script m·ªõi.';
        }

        /**
         * H√†m g·ªçi API Gemini ƒë·ªÉ t·∫°o script
         */
        async function generateScript() {
            const userQuery = requestInput.value.trim();

            if (!userQuery) {
                statusMessage.className = 'bg-red-900/50 text-red-200 p-3 rounded-lg border-l-4 border-red-400 font-medium transition duration-300';
                statusMessage.textContent = 'Vui l√≤ng nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n.';
                return;
            }

            setLoadingState(true);

            // 1. Th√™m tin nh·∫Øn m·ªõi c·ªßa ng∆∞·ªùi d√πng v√†o l·ªãch s·ª≠
            const userMessage = { role: "user", parts: [{ text: userQuery }] };
            chatHistory.push(userMessage);

            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            updateChatDisplay('user', userQuery);
            requestInput.value = ''; // X√≥a input

            // 2. Chu·∫©n b·ªã payload v·ªõi TO√ÄN B·ªò l·ªãch s·ª≠ chat
            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
            };

            let response;
            const MAX_RETRIES = 5;
            let delay = 1000;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 
                                           "L·ªói: Kh√¥ng th·ªÉ nh·∫≠n ph·∫£n h·ªìi code t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.";

                    // Lo·∫°i b·ªè Markdown Lua headers n·∫øu AI l·ª° th√™m v√†o
                    const cleanedScript = generatedText
                        .replace(/^```lua\s*/i, '')
                        .replace(/\s*```$/, '');

                    scriptOutput.value = cleanedScript.trim();

                    // 3. Th√™m ph·∫£n h·ªìi c·ªßa AI v√†o l·ªãch s·ª≠ chat
                    const aiMessage = { role: "model", parts: [{ text: cleanedScript }] };
                    chatHistory.push(aiMessage);
                    updateChatDisplay('model', "Script Updated"); // Hi·ªÉn th·ªã th√¥ng b√°o c·∫≠p nh·∫≠t ng·∫Øn g·ªçn

                    if (cleanedScript.includes("L·ªói:") || cleanedScript.length < 10) {
                        statusMessage.className = 'bg-red-900/50 text-red-200 p-3 rounded-lg border-l-4 border-red-400 font-medium transition duration-300';
                        statusMessage.textContent = "AI g·∫∑p l·ªói. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c x√≥a b·ªô nh·ªõ.";
                    } else {
                        statusMessage.className = 'bg-green-900/50 text-green-200 p-3 rounded-lg border-l-4 border-green-400 font-medium transition duration-300';
                        statusMessage.textContent = "ƒê√£ c·∫≠p nh·∫≠t script th√†nh c√¥ng! (T·ªëi ∆∞u cho Mobile).";
                    }
                    
                    break; 

                } catch (error) {
                    console.error('Fetch error:', error);
                    scriptOutput.value = `--[[ L·ªói K·∫øt N·ªëi API ]]--\n-- Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn AI: ${error.message}`;
                    // X√≥a tin nh·∫Øn ng∆∞·ªùi d√πng cu·ªëi c√πng kh·ªèi l·ªãch s·ª≠ n·∫øu x·∫£y ra l·ªói
                    chatHistory.pop(); 
                    statusMessage.className = 'bg-red-900/50 text-red-200 p-3 rounded-lg border-l-4 border-red-400 font-medium transition duration-300';
                    statusMessage.textContent = `L·ªói k·∫øt n·ªëi ho·∫∑c API: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`;
                    break;
                } finally {
                    setLoadingState(false);
                }
            }
        }

        // --- Kh·ªüi t·∫°o ---
        document.addEventListener('DOMContentLoaded', () => {
            copyButton.disabled = true;
            scriptOutput.addEventListener('input', () => {
                copyButton.disabled = scriptOutput.value.length === 0;
            });
            setLoadingState(false);
        });
    </script>
</body>
</html>


